<%= content_for :body_class do "menu-collapse" end %>
<%= content_for :head_content do %>
  <link href='https://cdn.jsdelivr.net/npm/froala-editor@3.1.0/css/froala_editor.pkgd.min.css' rel='stylesheet' type='text/css' />
<% end %>
<div class="row">
  <div class="col s12 m3">
    <ul class="collapsible collapsible-accordion">
      <% if @document.estimate? %>
        <li>
          <div class="collapsible-header" tabindex="0"><i class="material-icons">mic_none</i> Estimate/Order</div>
          <div class="collapsible-body white">

            <div class="chip drag-text"  draggable="true" data-value="{{estimate.code}}" >
              <i class="material-icons chip-icon">open_with</i>
              Estimate Code
            </div>
            <div class="chip drag-text"  draggable="true" data-value="{{estimate.price}}" >
              <i class="material-icons chip-icon">open_with</i>
              Estimate Price
            </div>
            <div class="chip drag-text" draggable="true" data-value="{{estimate.title}}">
              <i class="material-icons chip-icon">open_with</i>
              Estimate Title
            </div>
            <div class="chip drag-text" draggable="true" data-value="{{estimate.total}}">
              <i class="material-icons chip-icon">open_with</i>
              Estimate Total
            </div>
            <div class="chip drag-text" draggable="true" data-value="{{estimate.value_with_tax}}">
              <i class="material-icons chip-icon">open_with</i>
              Start Date
            </div>
            <div class="chip drag-text" draggable="true" data-value="{{estimate.value_with_tax}}">
              <i class="material-icons chip-icon">open_with</i>
              End Date
            </div>
            <div class="chip drag-text" draggable="true" data-value="<img src='{{signature.link}}' />" > <!--<%%= wicked_pdf_image_tag '{{signature.link}}' %>  -->
              <i class="material-icons chip-icon">open_with</i>
              Signature
            </div>
          </div>
        </li>
        <li>
          <div class="collapsible-header" tabindex="0"><i class="material-icons">mic_none</i> Customer</div>
          <div class="collapsible-body white">
            <div class="chip drag-text"  draggable="true" data-value="{{customer.name}}" >
              <i class="material-icons chip-icon">open_with</i>
              Name
            </div>
            <div class="chip drag-text" draggable="true" data-value="{{customer.name | split: ' ' | first }}">
              <i class="material-icons chip-icon">open_with</i>
              First Name
            </div>
            <div class="chip drag-text" draggable="true" data-value="{{customer.name | split: ' ' | last }}">
              <i class="material-icons chip-icon">open_with</i>
              Last Name
            </div>
            <div class="chip drag-text" draggable="true" data-value="{{customer.since }}">
              <i class="material-icons chip-icon">open_with</i>
              Since
            </div>
            <div class="chip drag-text" draggable="true" data-value="{{customer.code }}">
              <i class="material-icons chip-icon">open_with</i>
              Code
            </div>
          </div>
        </li>
        <li>
          <div class="collapsible-header" tabindex="0"><i class="material-icons">mic_none</i> Partials</div>
          <div class="collapsible-body white">
            <div class="chip drag-text"  draggable="true" data-value="{% for measurement in measurements %} {{measurement.name}} {{measurement.description}} {{measurement.height}} {{measurement.length}}
  {{measurement.width}} {% endfor %}" >
              <i class="material-icons chip-icon">open_with</i>
              Measurements
            </div>
            <div class="chip drag-text" draggable="true" data-value="{% for product in products %} {{product.name}} {{product.discount}} {{product.quantity}} {{product.tax}}
  {{product.unitary_value}} {{product.value}} {% endfor %}">
              <i class="material-icons chip-icon">open_with</i>
              Products
            </div>

          </div>
        </li>
      <% end %>
      <li>
        <div class="collapsible-header" tabindex="0"><i class="material-icons">mic_none</i> Customized Fields</div>
        <div class="collapsible-body white">
            <% @document.document_custom_fields.each do |d| %>
            <div class="chip drag-text"  draggable="true" data-value="{{custom.<%= d.name %>}}" >
              <i class="material-icons chip-icon">open_with</i>
              <%= d.name %>
            </div>
            <% end  %>
        </div>
      </li>
    </ul>
  </div>
  <div class="col s12 m9">
    <div class="card-panel">
      <div id="froala-editor">
        <% if document.data.blank? %>
        <h3>Click here to edit the content</h3>
        <p>Drag the image above or the text block to insert them in the editor.</p>
        <% else %>
          <%= document.data.html_safe %>
        <% end %>
      </div>
    </div>
  </div>
</div>
<button id="save_data" class="btn"><%= t "button.save" %></button>
<%= content_for :scripts do %>
  <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/froala-editor@3.1.0/js/froala_editor.pkgd.min.js'></script>
  <script>

      $("#save_data").click(function(){
          //

          var editor = new FroalaEditor('#froala-editor', {}, function () {
              // Call the method inside the initialized event.
              data = editor.html.get(true);
          });

          $.post( "<%= save_data_documents_path %>", { document: "<%= document.id %>", data: editor.html.get(true) },function(data){
              M.toast({html: data["success"]});
          } );


      });

      var dragCallback = function (e) {
          e.dataTransfer.setData('Text', this.dataset.value);
      };

      // For Firefox to work.
      $('.drag-text').each(function () {
          this.addEventListener('dragstart', dragCallback);
      });

      new FroalaEditor('div#froala-editor', {
          events: {
              initialized: function () {
                  var editor = this;



                  editor.events.on('drop', function (dropEvent) {
                      // Focus at the current posisiton.
                      editor.markers.insertAtPoint(dropEvent.originalEvent);
                      var $marker = editor.$el.find('.fr-marker');
                      $marker.replaceWith(FroalaEditor.MARKERS);
                      editor.selection.restore();

                      // Save into undo stack the current position.
                      if (!editor.undo.canDo()) editor.undo.saveStep();

                      // Insert HTML.
                      editor.html.insert(dropEvent.originalEvent.dataTransfer.getData('Text') );

                      // Save into undo stack the changes.
                      editor.undo.saveStep();

                      // Stop event propagation.
                      dropEvent.preventDefault();
                      dropEvent.stopPropagation();

                      // Firefox show cursor.
                      if (editor.core.hasFocus() && editor.browser.mozilla) {
                          editor.events.disableBlur();
                          setTimeout(function () {
                              editor.$el.blur().focus();
                              editor.events.enableBlur();
                          }, 0);
                      }

                      return false;
                  }, true);
              }
          }
      })
  </script>
<% end %>