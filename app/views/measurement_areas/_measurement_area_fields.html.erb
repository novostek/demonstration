<%= content_for :head_content do %>
  <style>
    div.disabled-div-img {
      pointer-events: none;

      /* for "disabled" effect */
      opacity: 0.5;
      background: #CCC;
    }
  </style>
<% end %>

<div class="row m-area pt-1 mt-2 nested-fields">
  <%# <a href="#" class="btn-close-area"><i class="material-icons">close</i></a> %>
  <%= link_to_remove_association f, class: "btn-close-area" do %>
    <i class="material-icons">close</i>
  <% end %>
  <div class="m-area--info">
    <div class="input-field col s12 m6 l3">
      <%= f.text_field :name, class: "validade", autofocus: 'true' %>
      <%= f.label :name %>
    </div>
    <div class="input-field col s12 m6 l3">
      <%= f.text_field :description, class: "validade" %>
      <%= f.label :description %>
    </div>
  </div>
  <%= f.fields_for :measurements, f.object.new_record? ? f.object.measurements.build : f.object.measurements do |measures| %>
    <%= render 'measurement_fields', m: measures %>
  <% end %>

  <% if f.object.id.present? %>
    <div>
      <%= f.file_field :images, onchange: "uploadImage(this);", 'data-id-ma' => f.object.id, multiple: true %>
    </div>
    <div id="gallery-staging-<%= f.object.id %>" style="border-bottom: 1px solid; margin-bottom: 5px;" class="mt-1 pl-1"></div>

    <div id="gallery-saved-<%= f.object.id %>" class="mt-2 pl-1 gallery-saved">
      <% f.object.images.each_with_index do |image, index| %>
        <div id="<%= index %>" style="display:inline-block;border-radius: 5px;" class="grey lighten-3 mr-1 pt-1 pl-1 mb-1">
          <%= image_tag image.url, height: 100 %>
          <%= link_to remove_image_measurement_area_path(f.object, id_image: index), method: :delete, class: 'btn-delete-img', data: {confirm: "Are you sure you want to delete this image?"}, remote: true do %>
            <i class="material-icons red-text">delete</i>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="col s12">
      <div class="file-field input-field">
        <div class="btn right">
          <span><%= t 'texts.images' %></span>
          <%= f.file_field :images, multiple: true %>
        </div>
        <div class="file-path-wrapper pl-0">
          <input class="file-path validate" type="text"
                 placeholder="Upload one or more photos">
        </div>
      </div>
    </div>
  <% end %>

</div>

<%= content_for :scripts do %>
  <script type="text/javascript" charset="utf-8">
      // Exibir as imagens selecionadas
      function uploadImage(element) {
          const field = $(element);

          const galery = $(`#gallery-staging-${field.attr('data-id-ma')}`);

          if (galery.children('img').length > 0) galery.empty();

          if (field.get(0).files) {
              var filesAmount = field.get(0).files.length;

              for (i = 0; i < filesAmount; i++) {
                  var reader = new FileReader();

                  reader.onload = function (event) {
                      $($.parseHTML('<img>'))
                          .attr('src', event.target.result)
                          .attr('height', 100)
                          .css('margin-right', '5px')
                          .appendTo(`#gallery-staging-${field.attr('data-id-ma')}`);
                  };

                  reader.readAsDataURL(field.get(0).files[i]);
              }
          }
      }

      // Disabled image
      $(document).on('confirm:complete', function (e) {
          // user confirmed!
          if (e.originalEvent.detail[0]) {
              $(e.target.parentElement).addClass('disabled-div-img');
          }
      });
  </script>
<% end %>